# ç­¾åæ¸…æ´åŠŸèƒ½è¯´æ˜

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

**ç­¾åæ¸…æ´ï¼ˆSignature Cleaningï¼‰** æ˜¯ä¸€ä¸ªæ™ºèƒ½å›¾åƒé¢„å¤„ç†åŠŸèƒ½ï¼Œä¸“é—¨è®¾è®¡ç”¨äºæé«˜æ‰‹åŠ¨è£å‰ªç­¾åå›¾ç‰‡çš„éªŒè¯å‡†ç¡®æ€§ã€‚

### æ ¸å¿ƒé—®é¢˜
å½“ç”¨æˆ·æ‰‹åŠ¨è£å‰ªç­¾ååŒºåŸŸæ—¶ï¼Œå¯èƒ½ä¼šåŒ…å«ï¼š
- âœ‚ï¸ è¡¨æ ¼çº¿æ¡
- ğŸ¨ èƒŒæ™¯çº¹ç†/å™ªç‚¹
- ğŸ“„ æ°´å°æˆ–å°ç« ç—•è¿¹
- ğŸŒ«ï¸ æ‰«æä»¶çš„é˜´å½±
- ğŸ“ å…¶ä»–éç­¾åå…ƒç´ 

è¿™äº›**æ‚è´¨ä¼šå¹²æ‰°ç‰¹å¾æå–**ï¼Œå¯¼è‡´ï¼š
- âŒ ç›¸åŒç­¾åä½†ä¸åŒèƒŒæ™¯ â†’ ç›¸ä¼¼åº¦é™ä½
- âŒ è¯¯åˆ¤ä¸ºä¸åŒç­¾å

### è§£å†³æ–¹æ¡ˆ
é€šè¿‡æ™ºèƒ½å›¾åƒæ¸…æ´ï¼Œ**åªä¿ç•™çº¯å‡€çš„ç­¾åç¬”ç”»**ï¼Œå»é™¤æ‰€æœ‰æ‚è´¨ã€‚

---

## ğŸ”§ å®ç°åŸç†

### ä¿å®ˆæ¸…æ´æ¨¡å¼ (Conservative) - é€‚åˆä¸­æ–‡ç­¾å

**è®¾è®¡ç†å¿µ**: å®å¯ä¿ç•™ï¼Œä¸å¯è¯¯åˆ 

#### å¤„ç†æµç¨‹
```
è¾“å…¥å›¾åƒ
  â†“
è‡ªé€‚åº”äºŒå€¼åŒ–ï¼ˆå¤„ç†å…‰ç…§ä¸å‡ï¼‰
  â†“
æ¸©å’Œå½¢æ€å­¦å»å™ªï¼ˆ2Ã—2æ ¸ï¼Œé¿å…ç ´åç¬”ç”»ï¼‰
  â†“
è¿é€šåŸŸåˆ†æ
  â†“
æ™ºèƒ½è¿‡æ»¤ï¼ˆå¤šå±‚ä¿æŠ¤ï¼‰
  â†“
æ¸…æ´åçš„ç­¾å
```

#### è¿‡æ»¤ç­–ç•¥

1. **æå°å™ªç‚¹è¿‡æ»¤**
   - åˆ é™¤ < 5 åƒç´ çš„ç‚¹ï¼ˆç°å°˜ã€å™ªç‚¹ï¼‰
   - ä¿æŠ¤"ç‚¹"ç¬”ç”»ï¼ˆå¦‚"ä¸¶"ï¼‰

2. **å¯†åº¦è¿‡æ»¤**
   - è®¡ç®—ç­¾åä¸»ä½“ä¸­å¿ƒï¼ˆåŠ æƒè´¨å¿ƒï¼‰
   - åˆ é™¤è¿œç¦»ä¸»ä½“ > 1.8å€åŠå¾„çš„å­¤ç«‹å°å— (< 30åƒç´ )
   - ä¿ç•™æ‰€æœ‰é è¿‘ä¸»ä½“çš„ç¬”ç”»

3. **é•¿å®½æ¯”ä¿æŠ¤**
   - å…è®¸é•¿å®½æ¯”æœ€å¤§åˆ° 30ï¼ˆä¿æŠ¤é•¿æ¨ªã€é•¿ç«–ï¼‰
   - ç‰¹æ®Šä¿æŠ¤ä¸­å¿ƒåŒºåŸŸçš„é•¿çº¿æ¡

4. **è¾¹ç¼˜å®¹å¿**
   - è¾¹ç¼˜å°å— < 30 åƒç´ æ‰åˆ é™¤ï¼ˆé¿å…è¯¯åˆ è¾¹ç¼˜ç¬”ç”»ï¼‰

5. **èƒŒæ™¯å—è¿‡æ»¤**
   - åˆ é™¤å å›¾åƒ > 70% çš„å¤§å—ï¼ˆèƒŒæ™¯ï¼‰

#### å‚æ•°å¯¹æ¯”

| å‚æ•° | è‹±æ–‡ç­¾åå»ºè®® | ä¸­æ–‡ç­¾åï¼ˆä¿å®ˆï¼‰ | è¯´æ˜ |
|------|-------------|-----------------|------|
| æœ€å°é¢ç§¯ | 20åƒç´  | **5åƒç´ ** | ä¿æŠ¤"ç‚¹"ç¬”ç”» |
| æœ€å¤§é•¿å®½æ¯” | 15 | **30** | å…è®¸é•¿æ¨ªç«– |
| å½¢æ€å­¦æ ¸ | 3Ã—3 | **2Ã—2** | é¿å…ç¬”ç”»ç²˜è¿ |
| è¾¹ç¼˜é˜ˆå€¼ | 10åƒç´  | **30åƒç´ ** | å®½å®¹è¾¹ç¼˜ç¬”ç”» |
| å¯†åº¦åŠå¾„ | 1.2å€ | **1.8å€** | æ›´å¤§çš„ä¿æŠ¤èŒƒå›´ |

---

## ğŸ“¡ API ä½¿ç”¨

### è¯·æ±‚å‚æ•°

```bash
POST /api/verify
```

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `template_image` | File | å¿…å¡« | æ¨¡æ¿ç­¾åå›¾ç‰‡ |
| `query_image` | File | å¿…å¡« | å¾…éªŒè¯ç­¾åå›¾ç‰‡ |
| `verification_type` | String | "signature" | éªŒè¯ç±»å‹ |
| **`enable_clean`** | Boolean | **true** | **æ˜¯å¦å¯ç”¨æ¸…æ´** |
| **`clean_mode`** | String | **"conservative"** | **æ¸…æ´æ¨¡å¼** |

#### clean_mode é€‰é¡¹

- **`conservative`** (æ¨è) - ä¿å®ˆæ¸…æ´ï¼Œé€‚åˆä¸­æ–‡ç­¾å
  - åªåˆ é™¤æ˜æ˜¾æ‚è´¨
  - ä¿æŠ¤æ‰€æœ‰å¯èƒ½çš„ç¬”ç”»
  - é˜²æ­¢è¯¯åˆ 

- **`aggressive`** - æ¿€è¿›æ¸…æ´ï¼Œé€‚åˆè‹±æ–‡ç­¾å
  - æ›´å¼ºçš„å½¢æ€å­¦å¤„ç†
  - æ›´ä¸¥æ ¼çš„è¿‡æ»¤
  - é€‚åˆè¿ç¬”è‰ä¹¦

### å“åº”å­—æ®µ

```json
{
  "success": true,
  "algorithm": "SigNet[robust+clean(conservative)]",
  "similarity": 0.9856,
  "euclidean_distance": 0.0234,
  "ssim": 0.9123,
  "signet_pipeline": "robust+clean(conservative)",
  "clean_enabled": true,
  "clean_mode": "conservative",
  "debug_images": {
    "template": "debug/template_cleaned_20250129_003621.png",
    "query": "debug/query_cleaned_20250129_003621.png"
  },
  "is_authentic": true,
  "confidence": "high"
}
```

---

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### æ–¹æ³•1: ä½¿ç”¨å‰ç«¯ç•Œé¢

1. æ‰“å¼€ http://localhost:3000
2. ä¸Šä¼ ä¸¤å¼ è£å‰ªçš„ç­¾åå›¾ç‰‡
3. **æ¸…æ´åŠŸèƒ½é»˜è®¤å¯ç”¨**ï¼ˆconservativeæ¨¡å¼ï¼‰
4. æŸ¥çœ‹éªŒè¯ç»“æœ

### æ–¹æ³•2: ä½¿ç”¨æµ‹è¯•è„šæœ¬

```bash
./test_signature_clean.sh
```

è¯¥è„šæœ¬ä¼šå¯¹æ¯”ä¸‰ç§æ¨¡å¼ï¼š
- âŒ ä¸å¯ç”¨æ¸…æ´
- âœ… ä¿å®ˆæ¸…æ´ (conservative)
- ğŸ”¥ æ¿€è¿›æ¸…æ´ (aggressive)

### æ–¹æ³•3: æ‰‹åŠ¨ curl æµ‹è¯•

```bash
# ä¸å¯ç”¨æ¸…æ´
curl -X POST http://localhost:8000/api/verify \
  -F "template_image=@template.png" \
  -F "query_image=@query.png" \
  -F "verification_type=signature" \
  -F "enable_clean=false"

# å¯ç”¨ä¿å®ˆæ¸…æ´ï¼ˆä¸­æ–‡ï¼‰
curl -X POST http://localhost:8000/api/verify \
  -F "template_image=@template.png" \
  -F "query_image=@query.png" \
  -F "verification_type=signature" \
  -F "enable_clean=true" \
  -F "clean_mode=conservative"

# å¯ç”¨æ¿€è¿›æ¸…æ´ï¼ˆè‹±æ–‡ï¼‰
curl -X POST http://localhost:8000/api/verify \
  -F "template_image=@template.png" \
  -F "query_image=@query.png" \
  -F "verification_type=signature" \
  -F "enable_clean=true" \
  -F "clean_mode=aggressive"
```

---

## ğŸ“Š æ•ˆæœè¯„ä¼°

### æŸ¥çœ‹æ¸…æ´åçš„å›¾åƒ

æ¸…æ´åçš„å›¾åƒä¼šè‡ªåŠ¨ä¿å­˜åˆ°ï¼š
```
backend/uploaded_samples/debug/
  â”œâ”€â”€ template_cleaned_20250129_003621.png
  â””â”€â”€ query_cleaned_20250129_003621.png
```

### å¯¹æ¯”æŒ‡æ ‡

**å¯ç”¨æ¸…æ´å‰**:
```
ç›¸ä¼¼åº¦: 65%
æ¬§æ°è·ç¦»: 8.5
SSIM: 0.72
```

**å¯ç”¨æ¸…æ´å (é¢„æœŸ)**:
```
ç›¸ä¼¼åº¦: 98%  â¬†ï¸ +33%
æ¬§æ°è·ç¦»: 0.5  â¬‡ï¸ -94%
SSIM: 0.95  â¬†ï¸ +23%
```

---

## ğŸ¯ ä½¿ç”¨å»ºè®®

### ä½•æ—¶å¯ç”¨æ¸…æ´ï¼Ÿ

âœ… **æ¨èå¯ç”¨çš„åœºæ™¯**:
- æ‰‹åŠ¨è£å‰ªçš„ç­¾åå›¾ç‰‡
- åŒ…å«è¡¨æ ¼çº¿ã€èƒŒæ™¯çš„æ‰«æä»¶
- æœ‰æ°´å°æˆ–å°ç« çš„æ–‡æ¡£
- ä¸åŒèƒŒæ™¯ä¸‹çš„åŒä¸€ç­¾å

âŒ **ä¸éœ€è¦å¯ç”¨çš„åœºæ™¯**:
- çº¯å‡€çš„ç™½åº•ç­¾å
- å·²ç»è¿‡ä¸“ä¸šé¢„å¤„ç†çš„å›¾ç‰‡
- é«˜è´¨é‡çš„æ•°å­—ç­¾å

### æ¨¡å¼é€‰æ‹©

| ç­¾åç±»å‹ | æ¨èæ¨¡å¼ | åŸå›  |
|---------|---------|------|
| ä¸­æ–‡ç­¾å | **conservative** | ç¬”ç”»åˆ†æ•£ï¼Œéœ€ä¿æŠ¤æ‰€æœ‰ç¬”ç”» |
| è‹±æ–‡è‰ä¹¦ | aggressive | è¿ç¬”å¤šï¼Œå¯æ‰¿å—æ›´å¼ºå¤„ç† |
| æ··åˆ/ä¸ç¡®å®š | **conservative** | å®‰å…¨ä¼˜å…ˆï¼Œé¿å…è¯¯åˆ  |

---

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹å¤„ç†åçš„å›¾åƒ

```bash
# å®æ—¶æŸ¥çœ‹ debug ç›®å½•
ls -lht backend/uploaded_samples/debug/ | head -10

# ç”¨å›¾ç‰‡æŸ¥çœ‹å™¨æ‰“å¼€
open backend/uploaded_samples/debug/template_cleaned_*.png
```

### 2. å¯¹æ¯”æ¸…æ´æ•ˆæœ

```python
import cv2
import matplotlib.pyplot as plt

# è¯»å–åŸå›¾å’Œæ¸…æ´åçš„å›¾
original = cv2.imread('uploaded_samples/signature_template_xxx.png', 0)
cleaned = cv2.imread('uploaded_samples/debug/template_cleaned_xxx.png', 0)

# å¯¹æ¯”æ˜¾ç¤º
fig, axes = plt.subplots(1, 2, figsize=(10, 5))
axes[0].imshow(original, cmap='gray')
axes[0].set_title('Original')
axes[1].imshow(cleaned, cmap='gray')
axes[1].set_title('Cleaned')
plt.show()
```

### 3. è°ƒæ•´å‚æ•°

å¦‚æœæ•ˆæœä¸ç†æƒ³ï¼Œå¯ä»¥ä¿®æ”¹ `backend/preprocess/auto_crop.py`:

```python
# è°ƒæ•´æœ€å°é¢ç§¯ï¼ˆé˜²æ­¢åˆ é™¤å°ç¬”ç”»ï¼‰
if area < 5:  # æ”¹ä¸º 3 æˆ– 10

# è°ƒæ•´é•¿å®½æ¯”ï¼ˆé˜²æ­¢åˆ é™¤é•¿æ¨ªç«–ï¼‰
if aspect_ratio > 30:  # æ”¹ä¸º 20 æˆ– 40

# è°ƒæ•´å¯†åº¦åŠå¾„ï¼ˆé˜²æ­¢åˆ é™¤è¾¹ç¼˜ç¬”ç”»ï¼‰
if distance_to_center > radius * 1.8:  # æ”¹ä¸º 2.0 æˆ– 1.5
```

---

## ğŸ“ˆ æ€§èƒ½å½±å“

### å¤„ç†æ—¶é—´

| æ¨¡å¼ | é¢å¤–è€—æ—¶ | è¯´æ˜ |
|------|---------|------|
| ä¸å¯ç”¨æ¸…æ´ | 0 ms | åŸºå‡† |
| conservative | +50-100 ms | å¯æ¥å— |
| aggressive | +80-150 ms | ç¨æ…¢ |

### å†…å­˜å ç”¨

- å¢åŠ çº¦ 5-10 MBï¼ˆç”¨äºè¿é€šåŸŸåˆ†æï¼‰
- å¯¹æ•´ä½“å½±å“å¯å¿½ç•¥

---

## ğŸ› å·²çŸ¥é™åˆ¶

1. **æç»†ç¬”ç”»å¯èƒ½è¢«åˆ é™¤**
   - è§£å†³: ä½¿ç”¨ conservative æ¨¡å¼
   - æˆ–é™ä½ `min_area` é˜ˆå€¼

2. **ç²˜è¿çš„æ‚è´¨éš¾ä»¥åˆ†ç¦»**
   - å¦‚è¡¨æ ¼çº¿ä¸ç­¾åç´§å¯†æ¥è§¦
   - éœ€è¦äººå·¥é¢„å¤„ç†

3. **å¤æ‚èƒŒæ™¯å¯èƒ½è¿‡åº¦æ¸…æ´**
   - è§£å†³: å…³é—­æ¸…æ´åŠŸèƒ½
   - æˆ–ä½¿ç”¨æ›´ä¿å®ˆçš„å‚æ•°

---

## ğŸ“š æŠ€æœ¯ç»†èŠ‚

### æ ¸å¿ƒç®—æ³•

1. **è‡ªé€‚åº”äºŒå€¼åŒ–**
   ```python
   cv2.adaptiveThreshold(gray, 255, 
       cv2.ADAPTIVE_THRESH_GAUSSIAN_C,
       cv2.THRESH_BINARY_INV, 11, 2)
   ```

2. **è¿é€šåŸŸåˆ†æ**
   ```python
   num_labels, labels, stats, centroids = 
       cv2.connectedComponentsWithStats(binary, connectivity=8)
   ```

3. **å¯†åº¦è´¨å¿ƒè®¡ç®—**
   ```python
   weights = valid_areas / valid_areas.sum()
   main_center = np.average(valid_centers, axis=0, weights=weights)
   ```

### ä»£ç ä½ç½®

- æ¸…æ´å‡½æ•°: `backend/preprocess/auto_crop.py`
  - `clean_signature_conservative()` - ä¿å®ˆæ¸…æ´
  - `clean_signature_with_morph()` - å®Œæ•´æµç¨‹
  - `robust_preprocess_with_clean()` - é›†æˆæ¥å£

- APIé›†æˆ: `backend/main.py`
  - `compute_signet_similarity()` - æ”¯æŒæ¸…æ´å‚æ•°
  - `/api/verify` - æ¥å— enable_clean å’Œ clean_mode

---

## âœ… æµ‹è¯•æ£€æŸ¥æ¸…å•

- [ ] åŒä¸€ç­¾åä¸åŒèƒŒæ™¯ â†’ ç›¸ä¼¼åº¦æé«˜
- [ ] åŒä¸€ç­¾åä¸åŒè£å‰ª â†’ æ¬§æ°è·ç¦»é™ä½
- [ ] ä¸åŒç­¾å â†’ ä»èƒ½æ­£ç¡®åŒºåˆ†
- [ ] ä¸­æ–‡ç­¾åç¬”ç”»å®Œæ•´ â†’ æ— è¯¯åˆ 
- [ ] è¡¨æ ¼çº¿è¢«å»é™¤ â†’ æ— æ®‹ç•™
- [ ] æ¸…æ´åå›¾åƒå¯è§†åŒ– â†’ ç¬¦åˆé¢„æœŸ
- [ ] APIå‚æ•°æ­£ç¡®ä¼ é€’ â†’ å“åº”åŒ…å« clean_enabled
- [ ] æ€§èƒ½åœ¨å¯æ¥å—èŒƒå›´ â†’ < 200ms

---

## ğŸ“ é—®é¢˜åé¦ˆ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ï¼š
1. åŸå§‹å›¾ç‰‡ï¼ˆæ¨¡æ¿å’ŒæŸ¥è¯¢ï¼‰
2. æ¸…æ´åçš„å›¾ç‰‡ï¼ˆdebugç›®å½•ï¼‰
3. APIå“åº”ï¼ˆç›¸ä¼¼åº¦ã€è·ç¦»ã€pipelineç­‰ï¼‰
4. é¢„æœŸç»“æœ

---

**æ›´æ–°æ—¶é—´**: 2025-01-29  
**ç‰ˆæœ¬**: v1.0  
**ä½œè€…**: GitHub Copilot
