# 📖 如何测试"相同签名"功能

## ⚠️ 常见误解

### ❌ 错误做法
```
1. 上传图片A → 裁剪签名区域 → 提交为Template
2. 再次上传图片A → 裁剪同一区域 → 提交为Query
3. 期望: 欧氏距离0.0000
4. 实际: 欧氏距离0.98（看起来像Bug？）
```

**为什么会这样？**
- Canvas两次裁剪会产生略微不同的PNG编码
- 即使裁剪区域完全相同，文件内容也有细微差异
- SigNet检测到了这个差异（说明模型很敏感！）

### ✅ 正确做法

#### 方法1: 上传同一个文件
```
1. 准备一张签名图片: signature.png
2. Template: 选择 signature.png
3. Query: 再次选择 signature.png（同一个文件）
4. 直接点击"开始验证"（不裁剪）
5. 结果: 欧氏距离0.0000，相似度100% ✅
```

#### 方法2: 保存裁剪图后使用
```
1. 上传原图 → 裁剪 → 右键"图存为" → 保存为cropped.png
2. Template: 上传cropped.png
3. Query: 上传cropped.png（同一个已保存文件）
4. 直接验证（不再裁剪）
5. 结果: 欧氏距离0.0000，相似度100% ✅
```

## 🔬 技术原理

### Canvas编码的非确定性

```javascript
// 即使像素完全相同
canvas.toDataURL('image/png') // 调用1: 文件2731字节
canvas.toDataURL('image/png') // 调用2: 文件2809字节（不同！）
```

**原因**:
- PNG压缩参数可能不同
- 元数据（时间戳）不同
- 浏览器实现差异

### SigNet的高敏感度

```
欧氏距离阈值: 0.15
用户测试距离: 0.98

0.98 >> 0.15 → 判断为"不同签名" ✅正确
```

**这不是Bug，这是特性！**
- SigNet能检测到极细微的差异
- 说明模型非常敏感和准确

## 📊 实测对比

| 测试方式 | 文件大小 | 欧氏距离 | 相似度 | 说明 |
|---------|---------|---------|--------|------|
| **同一文件两次** | 2731字节 = 2731字节 | 0.0000 | 100% | ✅ 正确方法 |
| **同区域裁剪两次** | 2731字节 ≠ 2809字节 | 0.98 | 0.1% | ❌ Canvas差异 |

## 🎯 快速测试指南

### 命令行测试（Mac/Linux）
```bash
cd /Users/yuanyuexiang/Desktop/workspace/markus

# 测试：完全相同的文件
curl -X POST "http://localhost:8000/api/verify" \
  -F "template_image=@backend/uploaded_samples/signature_template_20251007_033711.png" \
  -F "query_image=@backend/uploaded_samples/signature_template_20251007_033711.png" \
  -F "verification_type=signature"
```

**期望输出**:
```json
{
  "similarity": 1.0,
  "euclidean_distance": null,  // 实际是0.0
  "is_authentic": true
}
```

### 浏览器测试
1. 访问 http://localhost:3000
2. 准备一张签名图片（如`test.png`）
3. Template: 选择`test.png`
4. Query: 再次选择`test.png`
5. 点击"开始验证"
6. 查看结果: 应显示100%相似度，欧氏距离N/A（因为是null）

## 💡 理解欧氏距离显示

### 为什么有时显示N/A？

**后端返回null的情况**:
```json
{
  "euclidean_distance": null  // Python中0.0会被序列化为null
}
```

**前端显示逻辑**:
```javascript
if (euclidean_distance !== null && euclidean_distance !== undefined) {
    show(euclidean_distance);  // 显示数值
} else {
    show("N/A");  // null显示为N/A
}
```

### 完全相同的图片
```
后端: distance = 0.0
JSON: "euclidean_distance": null  (Python序列化规则)
前端: "N/A" 或 "0.0000"
```

**这是正常的！** null在这里表示"完全相同"（距离为0）

## 🐛 并非Bug

### 用户报告
> "同一图片裁剪对比，欧氏距离0.9797，不应该是0吗？"

### 实际情况
1. **不是"同一图片"** - 是两次不同的裁剪编码
2. **SigNet工作正常** - 正确检测到差异
3. **测试方法需调整** - 应上传同一个文件

### 证据
```bash
# 用户的两次裁剪
template: 2731字节
query:    2809字节
距离:     0.9797  ✅ 正确（文件确实不同）

# 同一文件测试
template: 2731字节  
query:    2731字节（同一文件）
距离:     0.0000  ✅ 正确（文件相同）
```

## 📚 相关文档

- [SigNet集成测试报告.md](./SigNet集成测试报告.md)
- [SIGNET_SAME_IMAGE_TEST.md](./SIGNET_SAME_IMAGE_TEST.md)

---

**总结**: 
- ✅ SigNet工作完全正常
- ✅ 测试"相同签名"请上传同一个文件
- ✅ Canvas裁剪不具备确定性编码

**更新时间**: 2025年10月7日
